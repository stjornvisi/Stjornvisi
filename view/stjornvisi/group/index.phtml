<?php
$this->headTitle($this->group->name);
$this->headTitle('Hópur');

$this->headMeta()->setProperty('og:title', $this->group->name);
$this->headMeta()->setProperty('og:site_name', 'Stjórnvísi');
$this->headMeta()->setProperty('og:type', 'article');
$this->headMeta()->setProperty('og:description', mb_substr($this->group->summary, 0, 200));
$this->headMeta()->setProperty('og:url', 'http://' . $_SERVER['HTTP_HOST'] . $this->url('hopur/index', array('id' => $this->group->url)));

use Stjornvisi\Properties\FileProperties;
use \Stjornvisi\View\Helper\Date;

?>
<?php if ($this->access->is_admin || $this->access->type >= 1): ?>
<div class="panel panel--admin">
	<div class="panel__container">
		<div class="panel__content">
			<a href="<?=$this->url('hopur/update', array('id' => $this->group->url));?>" class="update"><i
					class="fa fa-check"></i> uppfæra</a>
			<?php if ($this->access->is_admin): ?>
				<a href="<?=$this->url('hopur/delete', array('id' => $this->group->url));?>"
				   class="update"><i class="fa fa-close"></i> eyða</a>
			<?php endif; ?>
			<a href="<?=$this->url('frettir/create', array('id' => $this->group->id))?>"><i
					class="fa fa-plus"></i> frétt</a>
			<a href="<?=$this->url('vidburdir/create', array('id' => $this->group->id))?>"><i
					class="fa fa-plus"></i> viðburð</a>
			<a href="<?=$this->url('hopur/send-mail', array('id' => $this->group->url, 'type' => 'allir'));?>"><i
					class="fa fa-envelope"></i> allir</a>
			<a href="<?=$this->url('hopur/send-mail', array('id' => $this->group->url, 'type' => 'formenn'));?>"><i
					class="fa fa-envelope"></i> stjórnendur</a>
			<a href="<?=$this->url('hopur/user-export', array('id' => $this->group->url));?>"><i
					class="fa fa-list"></i> meðlimalisti</a>
			<a href="<?=$this->url('hopur/board-export', array('id' => $this->group->url));?>"><i
					class="fa fa-list"></i> stjórnendalisti</a>
			<a href="<?=$this->url('hopur/chair-export', array('id' => $this->group->url));?>"><i
					class="fa fa-list"></i> formannalisti</a>
			<a href="<?=$this->url('hopur/event-export', array('id' => $this->group->url));?>"><i
					class="fa fa-list"></i> viðburðalisti</a>
		</div>
	</div>
</div>
<?php endif; ?>


<div class="panel panel--columns-two panel--ratio-sidebar-left">
	<div class="panel__container">
		<div class="panel__content">
			<div class="box">
				<div class="box">
					<div class="box__content">
						<?=$this->paragrapher($this->group->summary);?>
					</div>
				</div>

				<div class="box">
					<div class="box__title"><h3>Fyrri starfsár</h3></div>
					<div class="box__content">
						<ul>
							<?php foreach ($this->range->range as $group): ?>
								<li>
									<a href="<?=$this->url('hopur/index', array('id' => $this->group->url, 'range' => $group[0] . '-' . $group[1]))?>"><?=$group[0]?>
										- <?=$group[1]?></a></li>
							<?php endforeach; ?>
						</ul>
					</div>
				</div>

				<div class="box">
					<div class="box__title"><h3>Straumar</h3></div>
					<div class="box__content">
						<ul>
							<li><a href="<?=$this->url('rss/rss-news', array('name' => $this->group->url))?>"
								   title="RSS fréttastraumur" target="_blank">Fréttir <i class="fa fa-rss"></i></a></li>
							<li><a href="<?=$this->url('rss/rss-events', array('name' => $this->group->url))?>"
								   title="RSS viðburðastraumur" target="_blank">Viðburðir <i class="fa fa-rss"></i></a></li>
							<li>
								<a href="ical://<?=$_SERVER['HTTP_HOST']?><?=$this->url('hopur/ical', array('id' => $this->group->url))?>"
								   title="iCal viðburðastraumur" target="_blank">Viðburðir <i
										class="fa fa-calendar-o"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="box">
				<div class="box">
					<div class="box__title"><h1><?=$this->group->name;?></h1></div>
					<div class="box__content">
						<h2>Starfsár <?=$this->range->from->format('Y')?> - <?=$this->range->to->format('Y')?></h2>
						<?php if ($this->logged_in): ?>
							<?php if ($this->access->type === null): ?>
								<a href="<?=$this->url('hopur/register', array('id' => $this->group->url, 'type' => 1))?>"
								   class="btn btn-warning page-group__register">Skrá í hóp</a>
							<?php else: ?>
								<a href="<?=$this->url('hopur/register', array('id' => $this->group->url, 'type' => 0))?>"
								   class="btn btn-danger page-group__register">Afskrá úr hópi</a>
							<?php endif; ?>
						<?php else: ?>
							<a href="<?=$this->url('auth')?>" class="btn btn-danger page-group__register">Skrá í hóp</a>
						<?php endif; ?>
					</div>
				</div>

				<div class="box box--news col-sm-6">
					<div class="box__title"><h2 id="frettir">Fréttir</h2></div>
					<div class="box__content">
						<?foreach ($this->news as $news): ?>
							<div class="entry<?if($news->avatar):?> entry--has-image<?endif?>">
								<div class="entry__info"><?=$this->date($news->created_date,Date::FORMAT_DATE_TIME)?></div>
								<div class="entry__title"><h3><a href="<?=$this->url('frettir/index',array('id'=>$news->id))?>"><?=$news->title?></a></h3></div>
								<div class="entry__content">
									<?=$this->paragrapher( mb_substr($news->body,0,200,'utf-8').'&#8230;'  );?>
								</div>
								<div class="entry__image">
									<?if($news->avatar):?>
										<a href="<?=$this->url('frettir/index',array('id'=>$news->id))?>" class="block-element__poster">
											<?=$this->image($news->avatar, FileProperties::DIR_MEDIUM);?>
										</a>
									<?endif?>
								</div>
							</div>
						<?endforeach?>
					</div>
				</div>

				<div class="box box--events col-sm-6">
					<div class="box__title"><h2 id="vidburdir">Viðburðir</h2></div>
					<div class="box__content">
						<?foreach ($this->events as $event): ?>
							<div class="entry">
								<div class="entry__title">
									<div class="entry__date">
										<span class="day"><?=$this->date($event->event_date, Date::FORMAT_DAY)?></span>
										<span class="month"><?=$this->date($event->event_date, Date::FORMAT_MONTH_SHORT)?></span>
										<span class="year"><?=$this->date($event->event_date, Date::FORMAT_YEAR)?></span>
									</div>
									<h3><a href="<?=$this->url('vidburdir/index',array('id'=>$event->id))?>"><?=$event->subject?></a></h3>
									<div class="entry__info">
										<i class="fa fa-clock-o"></i>
										<? if($event->event_time) : ?>
											<?=$event->event_time->format("H:i")?>
											<? if($event->event_end) : ?>
												- <?=$event->event_end->format("H:i")?>
											<? endif; ?>
										<? endif; ?>
										<? if($event->location) : ?>
											<span class="separator">/</span>
											<i class="fa fa-map-marker"></i> <?=$event->location?>
										<? endif; ?>
									</div>
								</div>
								<div class="entry__content">
									<?=$this->paragrapher(mb_substr($event->body,0,200,'utf-8').'&#8230;'  );?>
								</div>
							</div>
						<?endforeach?>
					</div>
				</div>

				<div class="box">
					<div class="box__title"><h2 id="um">Um <?=$this->group->name;?></h2></div>
					<div class="box__content">
						<?=$this->paragrapher($this->group->body);?>
						<div id="fb-root"></div>
						<script>(function (d, s, id) {
								var js, fjs = d.getElementsByTagName(s)[0];
								if (d.getElementById(id)) return;
								js = d.createElement(s);
								js.id = id;
								js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=1645847542309046&version=v2.0";
								fjs.parentNode.insertBefore(js, fjs);
							}(document, 'script', 'facebook-jssdk'));</script>
						<div class="fb-like"
							 data-href="http://<?=$_SERVER['HTTP_HOST']?><?=$this->url('hopur/index', array('id' => $this->group->url))?>"
							 data-layout="button" data-action="like" data-show-faces="true"
							 data-share="true"></div>
					</div>
				</div>

				<div class="box">
					<div class="box__title"><h2 id="medlimir">Meðlimir</h2></div>
					<div class="box__content">

						<h3>Stjórn</h3>
						<?php
						//SOME LOGIC
						//	it would be super cool if I didn't have to do this here,
						//	but I need to split the list up, and this has nothing to
						//	with domain logic and everything with presentation
						//	so I have to make the view dirty with some PHP code
						$user_chunk = (count($this->managers))
							? array_chunk($this->managers, ceil(count($this->managers) / 3))
							: array();
						?>
						<div class="row">
							<?php foreach ($user_chunk as $chunk): ?>
								<ul class="col-sm-4">
								<?php foreach ($chunk as $user): ?>
									<li class="page-group__members-item <?=($user->type == 2) ? 'page-group__members-item--em' : ''?>"
										data-search="<?=$user->name;?>">
										<h5>
											<a href="<?=$this->url('notandi/index', array('id' => $user->id))?>"><?=$user->name;?></a>
										</h5>
										<div
											class="page-group__members-item--title"><?=($user->type == 2) ? 'Formaður' : 'Stjórnandi'?></div>
										<a href="mailto:<?=$user->email;?>"
										   class="page-group__members-item--email"><?=$user->email;?></a>
										<?php if ($user->company_id): ?>
											<div><a
													href="<?=$this->url('fyrirtaeki/index', ['id' => $user->company_id])?>"><?=$user->company_name;?></a></div>
										<?php endif; ?>
										<div><?=$user->title;?></div>
										<?php if ($this->access->is_admin || $this->access->type >= 1): ?>
											<stjonvisi-control class="inline">
												<a href="<?=$this->url('hopur/user-status', array('id' => $this->group->url, 'type' => 1, 'user_id' => $user->id))?>"><i
														class="fa fa-minus"></i> stjórnandi</a>
												<a href="<?=$this->url('hopur/user-status', array('id' => $this->group->url, 'type' => 0, 'user_id' => $user->id))?>"><i
														class="fa fa-minus"></i> meðlimur</a>
											</stjonvisi-control>
										<?php endif; ?>
									</li>
								<?php endforeach; ?>
							</ul>
						<?php endforeach; ?>
						</div>

						<?php if ($this->access->is_admin || $this->access->type >= 1): ?>
							<h3>Meðlimir (<?=count($this->users)?>)</h3>
							<?php
							//SOME LOGIC
							//	it would be super cool if I didn't have to do this here,
							//	but I need to split the list up, and this has nothing to
							//	with domain logic and everything with presentation
							//	so I have to make the view dirty with some PHP code
							$user_chunk = (count($this->users))
								? array_chunk($this->users, ceil(count($this->users) / 3))
								: array();
							?>

							<div class="row">
							<?php foreach ($user_chunk as $chunk): ?>
								<ul class="col-sm-4">
									<?php foreach ($chunk as $user): ?>
										<li class="page-group__members-item"
											data-search="<?=$user->name;?>">
											<h5>
												<a href="<?=$this->url('notandi/index', array('id' => $user->id))?>"><?=$user->name;?></a>
											</h5>
											<div><?=$user->title;?></div>
											<?php if ($user->company_id): ?>
												<div><a
														href="<?=$this->url('fyrirtaeki/index', ['id' => $user->company_id])?>"><?=$user->company_name;?></a></div>
											<?php endif; ?>
											<?php if ($this->access->is_admin || $this->access->type >= 1): ?>
												<stjonvisi-control class="inline">
													<a href="<?=$this->url('hopur/user-status', array('id' => $this->group->url, 'type' => 2, 'user_id' => $user->id))?>"><i
															class="fa fa-plus"></i> formaður</a>
													<a href="<?=$this->url('hopur/user-status', array('id' => $this->group->url, 'type' => 1, 'user_id' => $user->id))?>"><i
															class="fa fa-plus"></i> stjórnandi</a>
												</stjonvisi-control>
											<?php endif; ?>
										</li>
									<?php endforeach; ?>
								</ul>
							<?php endforeach; ?>
							</div>
						<?php endif; ?>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
